<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>貓咪都市Mao Do</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f9f9f9;
    }
    header {
      background: #444;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    .container {
      display: flex;
      padding: 1rem;
    }
    .sidebar {
      width: 220px;
      padding-right: 1rem;
    }
    .sidebar label {
      display: block;
      margin: 0.5rem 0 0.2rem;
      font-weight: bold;
    }
    .sidebar select {
      width: 100%;
      padding: 0.4rem;
      box-sizing: border-box;
    }
    .sidebar button {
      margin-top: 0.5rem;
      padding: 0.4rem;
      width: 100%;
    }
    .sidebar div.sort-options label {
      font-weight: normal;
      display: block;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .sidebar div.sort-options input {
      margin-right: 6px;
      vertical-align: middle;
      cursor: pointer;
    }
    .main {
      flex: 1;
    }
    .search {
      text-align: right;
      margin-bottom: 1rem;
    }
    .search input {
      padding: 0.5rem;
      width: 200px;
    }
    .search button {
      padding: 0.5rem 1rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }
    .card {
      background: white;
      padding: 0.5rem;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      font-size: 14px;
    }
    .card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      cursor: pointer;
      border-radius: 4px;
    }
    .card .date {
      color: #666;
      font-size: 12px;
      margin-top: 4px;
    }
    .pagination {
      text-align: center;
      margin-top: 1rem;
    }
    .pagination button {
      margin: 0 4px;
      padding: 0.4rem 0.7rem;
    }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal img {
      max-width: 90vw;
      max-height: 90vh;
      border: 5px solid white;
      border-radius: 6px;
    }
    .modal-close {
      position: fixed;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body>
  <header>貓咪都市Mao Do</header>
  <div class="container">
    <div class="sidebar">
      <label>產品種類：</label>
      <select id="filterCategory">
        <option value="all">全部</option>
      </select>
      <label>廠牌名稱：</label>
      <select id="filterBrand">
        <option value="all">全部</option>
      </select>
      <label>排序方式：</label>
      <div class="sort-options">
        <label><input type="radio" name="sortOrder" value="default" checked> 無排序</label>
        <label><input type="radio" name="sortOrder" value="priceDesc"> 價格由高到低</label>
        <label><input type="radio" name="sortOrder" value="priceAsc"> 價格由低到高</label>
        <label><input type="radio" name="sortOrder" value="newest"> 最新上架</label>
      </div>
      <button onclick="applyFilters()">確認</button>
    </div>
    <div class="main">
      <div class="search">
        <input type="text" id="searchInput" placeholder="搜尋產品名稱..." />
        <button onclick="applyFilters()">搜尋</button>
      </div>
      <div id="productGrid" class="grid"></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
  <div class="modal" id="imageModal" onclick="closeModal(event)">
    <span class="modal-close" onclick="closeModal(event)">×</span>
    <img id="modalImage" src="" />
  </div>
  <script>
    let products = [];
    let filteredProducts = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let lastStoredData = "";

    const grid = document.getElementById('productGrid');
    const categoryFilter = document.getElementById('filterCategory');
    const brandFilter = document.getElementById('filterBrand');
    const searchInput = document.getElementById('searchInput');
    const pagination = document.getElementById('pagination');

    function loadProducts() {
      const stored = localStorage.getItem("productData");
      if (stored) {
        lastStoredData = stored;
        products = JSON.parse(stored);
      } else {
        products = [];
      }
      products.forEach(p => {
        if (!p.date) {
          p.date = new Date().toISOString().slice(0,10);
        }
      });
    }

    function updateFilters() {
      const cats = new Set();
      const brands = new Set();
      products.forEach(p => {
        cats.add(p.category);
        brands.add(p.brand);
      });
      categoryFilter.innerHTML = '<option value="all">全部</option>';
      brandFilter.innerHTML = '<option value="all">全部</option>';
      cats.forEach(c => categoryFilter.innerHTML += `<option>${c}</option>`);
      brands.forEach(b => brandFilter.innerHTML += `<option>${b}</option>`);
    }

    function applyFilters() {
      const cat = categoryFilter.value;
      const brand = brandFilter.value;
      const keyword = searchInput.value.toLowerCase();
      filteredProducts = products.filter(p =>
        (cat === "all" || p.category === cat) &&
        (brand === "all" || p.brand === brand) &&
        p.name.toLowerCase().includes(keyword)
      );
      const sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;
      if (sortOrder === "priceDesc") {
        filteredProducts.sort((a,b) => b.price - a.price);
      } else if (sortOrder === "priceAsc") {
        filteredProducts.sort((a,b) => a.price - b.price);
      } else if (sortOrder === "newest") {
        filteredProducts.sort((a,b) => new Date(b.date) - new Date(a.date));
      }
      currentPage = 1;
      renderProducts();
    }

    function renderProducts() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filteredProducts.slice(start, end);
      grid.innerHTML = "";
      pageItems.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${p.img}" alt="${p.name}" onclick="showModal('${p.img}')">
          <div><strong>${p.name}</strong></div>
          <div>價格：$${p.price}</div>
          <div>分類：${p.category}</div>
          <div>廠牌：${p.brand}</div>
          <div class="date">上架時間：${p.date}</div>
        `;
        grid.appendChild(card);
      });
      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.disabled = true;
        btn.onclick = () => {
          currentPage = i;
          renderProducts();
        };
        pagination.appendChild(btn);
      }
    }

    function showModal(src) {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      img.src = src;
      modal.style.display = "flex";
    }

    function closeModal(e) {
      if (e.target.id === "imageModal" || e.target.className === "modal-close") {
        document.getElementById("imageModal").style.display = "none";
      }
    }

    function checkForUpdates() {
      const currentData = localStorage.getItem("productData");
      if (currentData !== lastStoredData) {
        loadProducts();
        updateFilters();
        applyFilters();
      }
    }

    searchInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") applyFilters();
    });

    loadProducts();
    updateFilters();
    applyFilters();
    setInterval(checkForUpdates, 3000);
  </script>
</body>
</html>